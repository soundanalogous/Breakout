/*!
 * Breakout v0.3.1 - 2014-03-09

 * Copyright (c) 2011-2014 Jeff Hoefs <soundanalogous@gmail.com> 
 * Released under the MIT license. See LICENSE file for details.
 * http://breakoutjs.com
 */
var BO=BO||{},BREAKOUT=BREAKOUT||BO;BREAKOUT.VERSION="0.3.1",BO.enableDebugging=!1;var JSUTILS=JSUTILS||{};JSUTILS.namespace=function(a){var b,c=a.split("."),d=window;for(b=0;b<c.length;b+=1)"undefined"==typeof d[c[b]]&&(d[c[b]]={}),d=d[c[b]];return d},JSUTILS.inherit=function(a){function b(){}if(null===a)throw new TypeError;if(Object.create)return Object.create(a);var c=typeof a;if("object"!==c&&"function"!==c)throw new TypeError;return b.prototype=a,new b},Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),JSUTILS.namespace("JSUTILS.Event"),JSUTILS.Event=function(){var a;return a=function(a){this._type=a,this._target=null,this.name="Event"},a.prototype={constructor:a,get type(){return this._type},set type(a){this._type=a},get target(){return this._target},set target(a){this._target=a}},a.CONNECTED="connected",a.CHANGE="change",a.COMPLETE="complete",a}(),JSUTILS.namespace("JSUTILS.EventDispatcher"),JSUTILS.EventDispatcher=function(){var a;return a=function(a){"use strict";this._target=a||null,this._eventListeners={},this.name="EventDispatcher"},a.prototype={constructor:a,addEventListener:function(a,b){this._eventListeners[a]||(this._eventListeners[a]=[]),this._eventListeners[a].push(b)},removeEventListener:function(a,b){for(var c=0,d=this._eventListeners[a].length;d>c;c++)this._eventListeners[a][c]===b&&this._eventListeners[a].splice(c,1)},hasEventListener:function(a){return this._eventListeners[a]&&this._eventListeners[a].length>0?!0:!1},dispatchEvent:function(a,b){a.target=this._target;var c=!1;for(var d in b)b.hasOwnProperty(d)&&(a[d.toString()]=b[d]);if(this.hasEventListener(a.type))for(var e=0,f=this._eventListeners[a.type].length;f>e;e++)try{this._eventListeners[a.type][e].call(this,a),c=!0}catch(g){console.log("error: Error calling event handler. "+g)}return c}},a}(),JSUTILS.namespace("JSUTILS.TimerEvent"),JSUTILS.TimerEvent=function(){var a,b=JSUTILS.Event;return a=function(a){this.name="TimerEvent",b.call(this,a)},a.TIMER="timerTick",a.TIMER_COMPLETE="timerComplete",a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a}(),JSUTILS.namespace("JSUTILS.Timer"),JSUTILS.Timer=function(){var a,b=JSUTILS.TimerEvent,c=JSUTILS.EventDispatcher;return a=function(a,b){c.call(this,this),this.name="Timer",this._count=0,this._delay=a,this._repeatCount=b||0,this._isRunning=!1,this._timer=null},a.prototype=JSUTILS.inherit(c.prototype),a.prototype.constructor=a,Object.defineProperties(a.prototype,{delay:{get:function(){return this._delay},set:function(a){this._delay=a,this._isRunning&&(this.stop(),this.start())}},repeatCount:{get:function(){return this._repeatCount},set:function(a){this._repeatCount=a,this._isRunning&&(this.stop(),this.start())}},running:{get:function(){return this._isRunning}},currentCount:{get:function(){return this._count}}}),a.prototype.start=function(){null===this._timer&&(this._timer=setInterval(this.onTick.bind(this),this._delay),this._isRunning=!0)},a.prototype.reset=function(){this.stop(),this._count=0},a.prototype.stop=function(){null!==this._timer&&(clearInterval(this._timer),this._timer=null,this._isRunning=!1)},a.prototype.onTick=function(){this._count=this._count+1,0!==this._repeatCount&&this._count>this._repeatCount?(this.stop(),this.dispatchEvent(new b(b.TIMER_COMPLETE))):this.dispatchEvent(new b(b.TIMER))},a}(),JSUTILS.namespace("JSUTILS.SignalScope"),JSUTILS.SignalScope=function(){var a;return a=function(a,b,c,d,e,f,g){this.name="SignalScope",this._canvas=document.getElementById(a),this._ctx=this._canvas.getContext("2d"),this._width=b,this._height=c,this._rangeMin=d,this._rangeMax=e,this._ch1Color=f||"#FF0000",this._ch2Color=g||"#0000FF",this._markers=null,this._ch1Values=new Array(b),this._ch2Values=new Array(b);for(var h=0;b>h;h++)this._ch1Values[h]=0,this._ch2Values[h]=0;this._range=100*(1/(e-d))},a.prototype.update=function(a,b){this._ctx.clearRect(0,0,this._width,this._height),this._ch1Values.push(a),this._ch1Values.shift(),this.drawChannel(this._ch1Values,this._ch1Color),void 0!==b&&(this._ch2Values.push(b),this._ch2Values.shift(),this.drawChannel(this._ch2Values,this._ch2Color)),this.drawMarkers()},a.prototype.drawChannel=function(a,b){var c=0;this._ctx.strokeStyle=b,this._ctx.lineWidth=1,this._ctx.beginPath(),this._ctx.moveTo(0,this._height);for(var d=0,e=a.length;e>d;d++)c=(this._rangeMax-a[d])*this._range,this._ctx.lineTo(d,c);this._ctx.stroke()},a.prototype.drawMarkers=function(){var a=0;if(null!==this._markers)for(var b=0,c=this._markers.length;c>b;b++)a=(this._rangeMax-this._markers[b][0])*this._range,this._ctx.strokeStyle=this._markers[b][1],this._ctx.lineWidth=.5,this._ctx.beginPath(),this._ctx.moveTo(0,a),this._ctx.lineTo(this._width,a),this._ctx.stroke()},a.prototype.addMarker=function(a,b){null===this._markers&&(this._markers=[]),this._markers.push([a,b])},a.prototype.removeAllMarkers=function(){this._markers=null},a}(),JSUTILS.namespace("BO.IOBoardEvent"),BO.IOBoardEvent=function(){var a,b=JSUTILS.Event;return a=function(a){this.name="IOBoardEvent",b.call(this,a)},a.ANALOG_DATA="analogData",a.DIGITAL_DATA="digitalData",a.FIRMWARE_VERSION="firmwareVersion",a.FIRMWARE_NAME="firmwareName",a.STRING_MESSAGE="stringMessage",a.SYSEX_MESSAGE="sysexMessage",a.PIN_STATE_RESPONSE="pinStateResponse",a.READY="ioBoardReady",a.CONNECTED="ioBoardConnected",a.DISCONNECTED="ioBoardDisonnected",a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a}(),JSUTILS.namespace("BO.WSocketEvent"),BO.WSocketEvent=function(){var a,b=JSUTILS.Event;return a=function(a){this.name="WSocketEvent",b.call(this,a)},a.CONNECTED="webSocketConnected",a.MESSAGE="webSocketMessage",a.CLOSE="webSocketClosed",a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a}(),JSUTILS.namespace("BO.WSocketWrapper"),BO.WSocketWrapper=function(){"use strict";var a,b=JSUTILS.EventDispatcher,c=BO.WSocketEvent,d={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};return a=function(a,c,d){this.name="WSocketWrapper",b.call(this,this),this._host=a,this._port=c,this._protocol=d||"default-protocol",this._socket=null,this._readyState=null,this.init(this)},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a.prototype.init=function(a){if("undefined"!=typeof io){a._socket=io.connect("http://"+a._host+":"+a._port);try{a._socket.on("connect",function(){a._socket.socket.options.reconnect=!1,a._readyState=d.OPEN,a.dispatchEvent(new c(c.CONNECTED)),a._socket.on("message",function(b){a.dispatchEvent(new c(c.MESSAGE),{message:b})})})}catch(b){console.log("Error "+b)}}else try{if("MozWebSocket"in window)a._socket=new MozWebSocket("ws://"+a._host+":"+a._port+"/websocket",a._protocol);else{if(!("WebSocket"in window))throw console.log("Websockets not supported by this browser"),new Error("Websockets not supported by this browser");a._socket=new WebSocket("ws://"+a._host+":"+a._port+"/websocket")}a._readyState=a._socket.readyState,a._socket.onopen=function(){a._readyState=a._socket.readyState,a.dispatchEvent(new c(c.CONNECTED)),a._socket.onmessage=function(b){a.dispatchEvent(new c(c.MESSAGE),{message:b.data})},a._socket.onclose=function(){a._readyState=a._socket.readyState,a.dispatchEvent(new c(c.CLOSE))}}}catch(b){console.log("Error "+b)}},a.prototype.send=function(a){this.sendString(a)},a.prototype.sendString=function(a){this.readyState===d.OPEN&&this._socket.send(a.toString())},Object.defineProperty(a.prototype,"readyState",{get:function(){return this._readyState}}),a}(),JSUTILS.namespace("BO.filters.FilterBase"),BO.filters.FilterBase=function(){"use strict";var a;return a=function(){throw new Error("Can't instantiate abstract classes")},a.prototype.processSample=function(){throw new Error("Filter objects must implement the method processSample")},a}(),JSUTILS.namespace("BO.filters.Scaler"),BO.filters.Scaler=function(){"use strict";var a,b=BO.filters.FilterBase;return a=function(b,c,d,e,f,g){this.name="Scaler",this._inMin=b||0,this._inMax=c||1,this._outMin=d||0,this._outMax=e||1,this._type=f||a.LINEAR,this._limiter=g||!0},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a.prototype.processSample=function(a){var b=this._inMax-this._inMin,c=this._outMax-this._outMin,d=(a-this._inMin)/b;return this._limiter&&(d=Math.max(0,Math.min(1,d))),c*this._type(d)+this._outMin},a.LINEAR=function(a){return a},a.SQUARE=function(a){return a*a},a.SQUARE_ROOT=function(a){return Math.pow(a,.5)},a.CUBE=function(a){return a*a*a*a},a.CUBE_ROOT=function(a){return Math.pow(a,.25)},a}(),JSUTILS.namespace("BO.filters.Convolution"),BO.filters.Convolution=function(){"use strict";var a,b=BO.filters.FilterBase;return a=function(a){this.name="Convolution",this._buffer=[],this.coef=a},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,Object.defineProperty(a.prototype,"coef",{get:function(){return this._coef},set:function(a){this._coef=a,this._buffer=new Array(this._coef.length);for(var b=this._buffer.length,c=0;b>c;c++)this._buffer[c]=0}}),a.prototype.processSample=function(a){this._buffer.unshift(a),this._buffer.pop();for(var b=0,c=this._buffer.length,d=0;c>d;d++)b+=this._coef[d]*this._buffer[d];return b},a.LPF=[1/3,1/3,1/3],a.HPF=[1/3,-2/3,1/3],a.MOVING_AVERAGE=[1/8,1/8,1/8,1/8,1/8,1/8,1/8,1/8],a}(),JSUTILS.namespace("BO.filters.TriggerPoint"),BO.filters.TriggerPoint=function(){"use strict";var a,b=BO.filters.FilterBase;return a=function(a){if(this.name="TriggerPoint",this._points={},this._range=[],this._lastStatus=0,void 0===a&&(a=[[.5,0]]),a[0]instanceof Array)for(var b=a.length,c=0;b>c;c++)this._points[a[c][0]]=a[c][1];else"number"==typeof a[0]&&(this._points[a[0]]=a[1]);this.updateRange(),this._lastStatus=0},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a.prototype.processSample=function(a){for(var b=this._lastStatus,c=this._range.length,d=0;c>d;d++){var e=this._range[d];if(e[0]<=a&&a<=e[1]){b=d;break}}return this._lastStatus=b,b},a.prototype.addPoint=function(a,b){this._points[a]=b,this.updateRange()},a.prototype.removePoint=function(a){delete this._points[a],this.updateRange()},a.prototype.removeAllPoints=function(){this._points={},this.updateRange()},a.prototype.updateRange=function(){this._range=[];var a=this.getKeys(this._points),b=a[0];this._range.push([Number.NEGATIVE_INFINITY,b-this._points[b]]);for(var c=a.length-1,d=0;c>d;d++){var e=a[d],f=a[d+1],g=1*e+this._points[e],h=f-this._points[f];if(g>=h)throw new Error("The specified range overlaps...");this._range.push([g,h])}var i=a[a.length-1],j=1*i+this._points[i];this._range.push([j,Number.POSITIVE_INFINITY])},a.prototype.getKeys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b.sort()},a}(),JSUTILS.namespace("BO.generators.GeneratorEvent"),BO.generators.GeneratorEvent=function(){"use strict";var a,b=JSUTILS.Event;return a=function(a){b.call(this,a),this.name="GeneratorEvent"},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a.UPDATE="update",a}(),JSUTILS.namespace("BO.generators.GeneratorBase"),BO.generators.GeneratorBase=function(){"use strict";var a,b=JSUTILS.EventDispatcher;return a=function(){b.call(this,this),this.name="GeneratorBase",this._value=void 0},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,Object.defineProperty(a.prototype,"value",{get:function(){return this._value},set:function(a){this._value=a}}),a}(),JSUTILS.namespace("BO.generators.Oscillator"),BO.generators.Oscillator=function(){"use strict";var a,b=BO.generators.GeneratorBase,c=BO.generators.GeneratorEvent,d=JSUTILS.Timer,e=JSUTILS.TimerEvent;return a=function(c,e,f,g,h,i){if(b.call(this),this.name="Oscillator",this._wave=c||a.SIN,this._freq=e||1,this._amplitude=f||1,this._offset=g||0,this._phase=h||0,this._times=i||0,0===e)throw new Error("Frequency should be larger than 0");this._time=void 0,this._startTime=void 0,this._lastVal=void 0,this._autoUpdateCallback=this.autoUpdate.bind(this),this._timer=new d(33),this._timer.start(),this.reset()},a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,Object.defineProperty(a.prototype,"serviceInterval",{get:function(){return this._timer.delay},set:function(a){this._timer.delay=a}}),a.prototype.start=function(){this.stop(),this._timer.addEventListener(e.TIMER,this._autoUpdateCallback);var a=new Date;this._startTime=a.getTime(),this.autoUpdate(null)},a.prototype.stop=function(){this._timer.hasEventListener(e.TIMER)&&this._timer.removeEventListener(e.TIMER,this._autoUpdateCallback)},a.prototype.reset=function(){this._time=0,this._lastVal=.999},a.prototype.update=function(a){a=a||-1,this._time+=0>a?this._timer.delay:a,this.computeValue()},a.prototype.autoUpdate=function(){var a=new Date;this._time=a.getTime()-this._startTime,this.computeValue()},a.prototype.computeValue=function(){var b=this._time/1e3;if(0!==this._times&&this._freq*b>=this._times)this.stop(),b=this._times/this._freq,this._value=this._wave!==a.LINEAR?this._offset:this._amplitude*this._wave(1,0)+this._offset;else{var d=this._freq*(b+this._phase);this._value=this._amplitude*this._wave(d,this._lastVal)+this._offset,this._lastVal=d}this.dispatchEvent(new c(c.UPDATE))},a.SIN=function(a){return.5*(1+Math.sin(2*Math.PI*(a-.25)))},a.SQUARE=function(a){return.5>=a%1?1:0},a.TRIANGLE=function(a){return a%=1,.5>=a?2*a:2-2*a},a.SAW=function(a){return a%=1,.5>=a?a+.5:a-.5},a.IMPULSE=function(a,b){return b%1>a%1?1:0},a.LINEAR=function(a){return 1>a?a:1},a}(),JSUTILS.namespace("BO.PinEvent"),BO.PinEvent=function(){var a,b=JSUTILS.Event;return a=function(a){this.name="PinEvent",b.call(this,a)},a.CHANGE="pinChange",a.RISING_EDGE="risingEdge",a.FALLING_EDGE="fallingEdge",a.prototype=JSUTILS.inherit(b.prototype),a.prototype.constructor=a,a}(),JSUTILS.namespace("BO.Pin"),BO.Pin=function(){"use strict";var a,b=JSUTILS.EventDispatcher,c=BO.PinEvent;return a=function(a,c){this.name="Pin",this._type=c,this._capabilities={},this._number=a,this._analogNumber=void 0,this._analogWriteResolution=255,this._analogReadResolution=1023,this._value=0,this._lastValue=-1,this._preFilterValue=0,this._average=0,this._minimum=Math.pow(2,16),this._maximum=0,this._sum=0,this._numSamples=0,this._filters=null,this._generator=null,this._state=void 0,this._autoSetValueCallback=this.autoSetValue.bind(this),this._evtDispatcher=new b(this)},a.prototype={constructor:a,setAnalogNumber:function(a){this._analogNumber=a},get analogNumber(){return this._analogNumber},get number(){return this._number},setAnalogWriteResolution:function(a){this._analogWriteResolution=a},setAnalogReadResolution:function(a){this._analogReadResolution=a},setState:function(b){this._type===a.PWM&&(b/=this.analogWriteResolution),this._state=b},get analogWriteResolution(){return this._analogWriteResolution},get analogReadResolution(){return this._analogReadResolution},get average(){return this._average},get minimum(){return this._minimum},get maximum(){return this._maximum},get state(){return this._state},get value(){return this._value},set value(a){this._lastValue=this._value,this._preFilterValue=a,this._value=this.applyFilters(a),this.calculateMinMaxAndMean(this._value),this.detectChange(this._lastValue,this._value)},get lastValue(){return this._lastValue},get preFilterValue(){return this._preFilterValue},get filters(){return this._filters},set filters(a){this._filters=a},get generator(){return this._generator},getType:function(){return this._type},setType:function(b){b>=0&&b<a.TOTAL_PIN_MODES&&(this._type=b)},getCapabilities:function(){return this._capabilities},setCapabilities:function(b){this._capabilities=b;var c=this._capabilities[a.PWM],d=this._capabilities[a.AIN];c&&this.setAnalogWriteResolution(Math.pow(2,c)-1),d&&this.setAnalogReadResolution(Math.pow(2,d)-1)},detectChange:function(a,b){a!==b&&(this.dispatchEvent(new c(c.CHANGE)),0>=a&&0!==b?this.dispatchEvent(new c(c.RISING_EDGE)):0!==a&&0>=b&&this.dispatchEvent(new c(c.FALLING_EDGE)))},clearWeight:function(){this._sum=this._average,this._numSamples=1},calculateMinMaxAndMean:function(a){var b=Number.MAX_VALUE;this._minimum=Math.min(a,this._minimum),this._maximum=Math.max(a,this._maximum),this._sum+=a,this._average=this._sum/++this._numSamples,this._numSamples>=b&&this.clearWeight()},clear:function(){this._minimum=this._maximum=this._average=this._lastValue=this._preFilterValue,this.clearWeight()},addFilter:function(a){null!==a&&(null===this._filters&&(this._filters=[]),this._filters.push(a))},removeFilter:function(a){var b;this._filters.length<1||(b=this._filters.indexOf(a),-1!==b&&this._filters.splice(b,1))},addGenerator:function(a){this.removeGenerator(),this._generator=a,this._generator.addEventListener("update",this._autoSetValueCallback)},removeGenerator:function(){null!==this._generator&&this._generator.removeEventListener("update",this._autoSetValueCallback),this._generator=null},removeAllFilters:function(){this._filters=null},autoSetValue:function(){var a=this._generator.value;this.value=a},applyFilters:function(a){var b;if(null===this._filters)return a;b=a;for(var c=this._filters.length,d=0;c>d;d++)b=this._filters[d].processSample(b);return b},addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}},a.HIGH=1,a.LOW=0,a.ON=1,a.OFF=0,a.DIN=0,a.DOUT=1,a.AIN=2,a.AOUT=3,a.PWM=3,a.SERVO=4,a.SHIFT=5,a.I2C=6,a.ONEWIRE=7,a.STEPPER=8,a.TOTAL_PIN_MODES=9,a}(),JSUTILS.namespace("BO.I2CBase"),BO.I2CBase=function(){"use strict";var a,b=BO.Pin,c=JSUTILS.EventDispatcher,d=BO.IOBoardEvent;return a=function(e,f,g){if(void 0!==e){this.name="I2CBase",this.board=e;var h=g||0,i=255&h,j=255&h>>7;this._address=f,this._evtDispatcher=new c(this);var k=e.getI2cPins();if(2!==k.length)return console.log("Error, this board does not support i2c"),void 0;e.getPin(k[0]).getType()!==b.I2C&&(e.getPin(k[0]).setType(b.I2C),e.getPin(k[1]).setType(b.I2C)),e.addEventListener(d.SYSEX_MESSAGE,this.onSysExMessage.bind(this)),e.sendSysex(a.I2C_CONFIG,[i,j])}},a.prototype={constructor:a,get address(){return this._address},onSysExMessage:function(b){var c=b.message,d=this.board.getValueFromTwo7bitBytes(c[1],c[2]),e=[];if(c[0]==a.I2C_REPLY&&d==this._address){for(var f=3,g=c.length;g>f;f+=2)e.push(this.board.getValueFromTwo7bitBytes(c[f],c[f+1]));this.handleI2C(e)}},sendI2CRequest:function(b){var c=[],d=b[1],e=b[0];c[0]=d,c[1]=e<<3;for(var f=2,g=b.length;g>f;f++)c.push(127&b[f]),c.push(127&b[f]>>7);this.board.sendSysex(a.I2C_REQUEST,c)},update:function(){},handleI2C:function(){},addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}},a.I2C_REQUEST=118,a.I2C_REPLY=119,a.I2C_CONFIG=120,a.WRITE=0,a.READ=1,a.READ_CONTINUOUS=2,a.STOP_READING=3,a}(),JSUTILS.namespace("BO.PhysicalInputBase"),BO.PhysicalInputBase=function(){var a,b=JSUTILS.EventDispatcher;return a=function(){this.name="PhysicalInputBase",this._evtDispatcher=new b(this)},a.prototype={constructor:a,addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}},a}(),JSUTILS.namespace("BO.IOBoard"),BO.IOBoard=function(){var a,b=144,c=224,d=192,e=208,f=244,g=249,h=255,i=240,j=247,k=112,l=113,m=111,n=109,o=110,p=107,q=108,r=105,s=106,t=121,u=122,v=10,w=100,x="multiClient",y=BO.Pin,z=JSUTILS.EventDispatcher,A=BO.PinEvent,B=BO.IOBoardEvent;return a=function(a,b,c){"use strict";this.name="IOBoard",this._socket=null,this._inputDataBuffer=[],this._digitalPort=[],this._numPorts=0,this._analogPinMapping=[],this._digitalPinMapping=[],this._i2cPins=[],this._ioPins=[],this._totalPins=0,this._totalAnalogPins=0,this._samplingInterval=19,this._isReady=!1,this._firmwareName="",this._firmwareVersion=0,this._evtDispatcher=null,this._isMultiClientEnabled=!1,this._isConfigured=!1,this._capabilityQueryResponseReceived=!1,this._debugMode=BO.enableDebugging,this._numPinStateRequests=0,this._evtDispatcher=new z(this),this.initialVersionResultHandler=this.onInitialVersionResult.bind(this),this.sendOutHandler=this.sendOut.bind(this),this.socketConnectionHandler=this.onSocketConnection.bind(this),this.socketMessageHandler=this.onSocketMessage.bind(this),this.socketClosedHandler=this.onSocketClosed.bind(this),this._socket=new BO.WSocketWrapper(a,b,c),this._socket.addEventListener(BO.WSocketEvent.CONNECTED,this.socketConnectionHandler),this._socket.addEventListener(BO.WSocketEvent.MESSAGE,this.socketMessageHandler),this._socket.addEventListener(BO.WSocketEvent.CLOSE,this.socketClosedHandler)},a.prototype={constructor:a,onSocketConnection:function(){this.debug("debug: Socket Status: (open)"),this.dispatchEvent(new B(B.CONNECTED)),this.begin()},onSocketMessage:function(a){var b,c=a.message,d=[];if(c.length>1){d=c.split(","),b=d.length;for(var e=0;b>e;e++)this.parseInputMessage(d[e])}else this.parseInputMessage(c)},parseInputMessage:function(a){var b=/config/,c="";a.match(b)?(c=a.substr(a.indexOf(":")+2),this.processStatusMessage(c)):this.processInput(parseInt(a,10))},onSocketClosed:function(){this.debug("debug: Socket Status: "+this._socket.readyState+" (Closed)"),this.dispatchEvent(new B(B.DISCONNECTED))},begin:function(){this.addEventListener(B.FIRMWARE_NAME,this.initialVersionResultHandler),this.reportFirmware()},onInitialVersionResult:function(a){var b=10*a.version,c=a.name,d=this;if(this.removeEventListener(B.FIRMWARE_NAME,this.initialVersionResultHandler),this.debug("debug: Firmware name = "+c+", Firmware version = "+a.version),b>=23)this._isMultiClientEnabled?(this.queryCapabilities(),this.checkForQueryResponse()):(this.systemReset(),setTimeout(function(){d.queryCapabilities(),d.checkForQueryResponse()},200));else{var e="error: You must upload StandardFirmata version 2.3 or greater from Arduino version 1.0 or higher";console.log(e)}},checkForQueryResponse:function(){var a=this;setTimeout(function(){a._capabilityQueryResponseReceived===!1&&a.startup()},200)},processStatusMessage:function(a){a===x&&(this.debug("debug: Multi-client mode enabled"),this._isMultiClientEnabled=!0)},processInput:function(a){var b;this._inputDataBuffer.push(a),b=this._inputDataBuffer.length,this._inputDataBuffer[0]>=128&&this._inputDataBuffer[0]!=i?3===b&&(this.processMultiByteCommand(this._inputDataBuffer),this._inputDataBuffer=[]):this._inputDataBuffer[0]===i&&this._inputDataBuffer[b-1]===j?(this.processSysexCommand(this._inputDataBuffer),this._inputDataBuffer=[]):a>=128&&this._inputDataBuffer[0]<128&&(console.log("warning: Malformed input data... resetting buffer"),this._inputDataBuffer=[],a!==j&&this._inputDataBuffer.push(a))},processMultiByteCommand:function(a){var d,e=a[0];switch(240>e&&(e=240&e,d=15&a[0]),e){case b:this.processDigitalMessage(d,a[1],a[2]);break;case g:this._firmwareVersion=a[1]+a[2]/10,this.dispatchEvent(new B(B.FIRMWARE_VERSION),{version:this._firmwareVersion});break;case c:this.processAnalogMessage(d,a[1],a[2])}},processDigitalMessage:function(a,b,c){var d,e=8*a,f=e+8,g=b|c<<7,h={};f>=this._totalPins&&(f=this._totalPins);for(var i=0,j=e;f>j;j++){if(h=this.getDigitalPin(j),void 0===h)return;h.getType()==y.DIN&&(d=1&g>>i,d!=h.value&&(h.value=d,this.dispatchEvent(new B(B.DIGITAL_DATA),{pin:h}))),i++}},processAnalogMessage:function(a,b,c){var d=this.getAnalogPin(a);void 0!==d&&(d.value=this.getValueFromTwo7bitBytes(b,c)/d.analogReadResolution,d.value!=d.lastValue&&this.dispatchEvent(new B(B.ANALOG_DATA),{pin:d}))},processSysexCommand:function(a){a.shift(),a.pop();var b=a[0];switch(b){case t:this.processQueryFirmwareResult(a);break;case l:this.processSysExString(a);break;case q:this.processCapabilitiesResponse(a);break;case o:this.processPinStateResponse(a);break;case s:this.processAnalogMappingResponse(a);break;default:this.dispatchEvent(new B(B.SYSEX_MESSAGE),{message:a})}},processQueryFirmwareResult:function(a){for(var b,c=3,d=a.length;d>c;c+=2)b=a[c],b+=a[c+1],this._firmwareName+=String.fromCharCode(b);this._firmwareVersion=a[1]+a[2]/10,this.dispatchEvent(new B(B.FIRMWARE_NAME),{name:this._firmwareName,version:this._firmwareVersion})},processSysExString:function(a){for(var b,c="",d=a.length,e=1;d>e;e+=2)b=a[e],b+=a[e+1],c+=String.fromCharCode(b);this.dispatchEvent(new B(B.STRING_MESSAGE),{message:c})},processCapabilitiesResponse:function(a){if(!this._isConfigured){var b,c,d={},e=1,f=0,g=0,h=a.length;for(this._capabilityQueryResponseReceived=!0;h>=e;)127==a[e]?(this._digitalPinMapping[f]=f,b=void 0,d[y.DOUT]&&(b=y.DOUT),d[y.AIN]&&(b=y.AIN,this._analogPinMapping[g++]=f),c=new y(f,b),c.setCapabilities(d),this.managePinListener(c),this._ioPins[f]=c,c.getCapabilities()[y.I2C]&&this._i2cPins.push(c.number),d={},f++,e++):(d[a[e]]=a[e+1],e+=2);this._numPorts=Math.ceil(f/8),this.debug("debug: Num ports = "+this._numPorts);for(var i=0;i<this._numPorts;i++)this._digitalPort[i]=0;this._totalPins=f,this._totalAnalogPins=g,this.debug("debug: Num pins = "+this._totalPins),this.queryAnalogMapping()}},processAnalogMappingResponse:function(a){if(!this._isConfigured){for(var b=a.length,c=1;b>c;c++)127!=a[c]&&(this._analogPinMapping[a[c]]=c-1,this.getPin(c-1).setAnalogNumber(a[c]));this._isMultiClientEnabled?this.startupInMultiClientMode():this.startup()}},startupInMultiClientMode:function(){for(var a=this.getPinCount(),b=0;a>b;b++)this.queryPinState(this.getDigitalPin(b));setTimeout(this.startup.bind(this),500),this._isConfigured=!0},startup:function(){this.debug("debug: IOBoard ready"),this._isReady=!0,this.enableDigitalPins(),this.dispatchEvent(new B(B.READY))},systemReset:function(){this.debug("debug: System reset"),this.send(h)},processPinStateResponse:function(a){if(!(this._numPinStateRequests<=0)){var b,c=a.length,d=a[1],e=a[2],f=this._ioPins[d];c>4?b=this.getValueFromTwo7bitBytes(a[3],a[4]):c>3&&(b=a[3]),f.getType()!=e&&(f.setType(e),this.managePinListener(f)),f.setState(b),this._numPinStateRequests--,this._numPinStateRequests<0&&(this._numPinStateRequests=0),this.dispatchEvent(new B(B.PIN_STATE_RESPONSE),{pin:f})}},toDec:function(a){a=a.substring(0,1);var b=a.charCodeAt(0);return b},sendOut:function(a){var b=a.target.getType(),c=a.target.number,d=a.target.value;switch(b){case y.DOUT:this.sendDigitalData(c,d);break;case y.AOUT:this.sendAnalogData(c,d);break;case y.SERVO:this.sendServoData(c,d)}},managePinListener:function(a){if(a.getType()==y.DOUT||a.getType()==y.AOUT||a.getType()==y.SERVO)a.hasEventListener(A.CHANGE)||a.addEventListener(A.CHANGE,this.sendOutHandler);else if(a.hasEventListener(A.CHANGE))try{a.removeEventListener(A.CHANGE,this.sendOutHandler)}catch(b){this.debug("debug: Caught pin removeEventListener exception")}},sendAnalogData:function(a,b){var d=this.getDigitalPin(a).analogWriteResolution;b*=d,b=0>b?0:b,b=b>d?d:b,a>15||b>Math.pow(2,14)?this.sendExtendedAnalogData(a,b):this.send([c|15&a,127&b,127&b>>7])},sendExtendedAnalogData:function(a,b){var c=[];if(b>Math.pow(2,16)){var d="error: Extended Analog values > 16 bits are not currently supported by StandardFirmata";throw console.log(d),d}c[0]=i,c[1]=m,c[2]=a,c[3]=127&b,c[4]=127&b>>7,b>=Math.pow(2,14)&&(c[5]=127&b>>14),c.push(j),this.send(c)},sendDigitalData:function(a,b){var c=Math.floor(a/8);if(b==y.HIGH)this._digitalPort[c]|=b<<a%8;else{if(b!=y.LOW)return console.log("warning: Invalid value passed to sendDigital, value must be 0 or 1."),void 0;this._digitalPort[c]&=~(1<<a%8)}this.sendDigitalPort(c,this._digitalPort[c])},sendServoData:function(a,b){var c=this.getDigitalPin(a);c.getType()==y.SERVO&&c.lastValue!=b&&this.sendAnalogData(a,b)},queryCapabilities:function(){this.send([i,p,j])},queryAnalogMapping:function(){this.send([i,r,j])},setAnalogPinReporting:function(a,b){this.send([d|a,b]),this.getAnalogPin(a).setType(y.AIN)},debug:function(a){this._debugMode&&console.log(a)},get samplingInterval(){return this._samplingInterval},set samplingInterval(a){a>=v&&w>=a?(this._samplingInterval=a,this.send([i,u,127&a,127&a>>7,j])):console.log("warning: Sampling interval must be between "+v+" and "+w)},get isReady(){return this._isReady},getValueFromTwo7bitBytes:function(a,b){return b<<7|a},getSocket:function(){return this._socket},reportVersion:function(){this.send(g)},reportFirmware:function(){this.send([i,t,j])},disableDigitalPins:function(){for(var a=0;a<this._numPorts;a++)this.sendDigitalPortReporting(a,y.OFF)},enableDigitalPins:function(){for(var a=0;a<this._numPorts;a++)this.sendDigitalPortReporting(a,y.ON)},sendDigitalPortReporting:function(a,b){this.send([e|a,b])},enableAnalogPin:function(a){this.setAnalogPinReporting(a,y.ON)},disableAnalogPin:function(a){this.setAnalogPinReporting(a,y.OFF)},setDigitalPinMode:function(a,b,c){this.getDigitalPin(a).setType(b),this.managePinListener(this.getDigitalPin(a)),c&&c===!0||this.send([f,a,b])},enablePullUp:function(a){this.sendDigitalData(a,y.HIGH)},getFirmwareName:function(){return this._firmwareName},getFirmwareVersion:function(){return this._firmwareVersion},getPinCapabilities:function(){var a,b,c,d,e=[],f={0:"input",1:"output",2:"analog",3:"pwm",4:"servo",5:"shift",6:"i2c",7:"onewire",8:"stepper"};a=this._ioPins.length;for(var g=0;a>g;g++){b={},c=this._ioPins[g].getCapabilities(),d=!1;for(var h in c)c.hasOwnProperty(h)&&(d=!0,h>=0&&(b[f[h]]=this._ioPins[g].getCapabilities()[h]));e[g]=d?b:{"not available":"0"}}return e},queryPinState:function(a){var b=a.number;this.send([i,n,b,j]),this._numPinStateRequests++},sendDigitalPort:function(a,c){this.send([b|15&a,127&c,c>>7])},sendString:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(127&this.toDec(a[c])),b.push(127&this.toDec(a[c])>>7);this.sendSysex(l,b)},sendSysex:function(a,b){var c=[];c[0]=i,c[1]=a;for(var d=0,e=b.length;e>d;d++)c.push(b[d]);c.push(j),this.send(c)},sendServoAttach:function(a,b,c){var d,e=[];b=b||544,c=c||2400,e[0]=i,e[1]=k,e[2]=a,e[3]=b%128,e[4]=b>>7,e[5]=c%128,e[6]=c>>7,e[7]=j,this.send(e),d=this.getDigitalPin(a),d.setType(y.SERVO),this.managePinListener(d)},getPin:function(a){return this._ioPins[a]},getAnalogPin:function(a){return this._ioPins[this._analogPinMapping[a]]},getDigitalPin:function(a){return this._ioPins[this._digitalPinMapping[a]]},getPins:function(){return this._ioPins},analogToDigital:function(a){return this.getAnalogPin(a).number},getPinCount:function(){return this._totalPins},getAnalogPinCount:function(){return this._totalAnalogPins},getI2cPins:function(){return this._i2cPins},reportCapabilities:function(){for(var a,b=this.getPinCapabilities(),c=b.length,d=0;c>d;d++){console.log("Pin "+d+":");for(var e in b[d])b[d].hasOwnProperty(e)&&(a=b[d][e],console.log("	"+e+" ("+a+(a>1?" bits)":" bit)")))}},send:function(a){this._socket.sendString(a)},close:function(){this._socket.close()},addEventListener:function(a,b){this._evtDispatcher.addEventListener(a,b)},removeEventListener:function(a,b){this._evtDispatcher.removeEventListener(a,b)},hasEventListener:function(a){return this._evtDispatcher.hasEventListener(a)},dispatchEvent:function(a,b){return this._evtDispatcher.dispatchEvent(a,b)}},a}();